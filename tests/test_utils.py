import pytest
from malware_detection_client import utils


class TestUtils:

    def test_run_cmd(self, caplog):
        # Test the run_cmd function
        # The passed in argument must be a list, with the command and (optional) argments
        with pytest.raises(SystemExit) as exc_info:
            utils.run_cmd('/bin/uname')
        assert "ERROR:Command '/bin/uname' must be specified as a list of arguments" in caplog.text
        assert exc_info.value.code == 1

        # Check output for various commands, with/without paths and with/without arguments
        output = utils.run_cmd(['/bin/uname'])
        assert output == 'Linux'
        output = utils.run_cmd(['uname'])
        assert output == 'Linux'
        output = utils.run_cmd(['/bin/uname', '-s', '-o'])
        assert output == 'Linux GNU/Linux'
        output = utils.run_cmd(['/bin/echo'])
        assert output == ''

        # Check output for missing rpm
        output = utils.run_cmd(['/bin/rpm', '-ql', 'malware-detection-clientz'])
        assert output == 'package malware-detection-clientz is not installed'

        # Try to run a command that doesn't exist
        caplog.clear()
        with pytest.raises(SystemExit) as exc_info:
            utils.run_cmd(['/bin/fred'])
        assert "ERROR:Problem running command '['/bin/fred']':" in caplog.text
        assert exc_info.value.code == 1
