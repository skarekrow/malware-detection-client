import os
import string
import random
from malware_detection_client.process_include_exclude_items import get_parent_dirs
try:
    from urllib import quote as urlencode
except ImportError:
    from urllib.parse import quote as urlencode


def get_random_string():
    # Used for making randomized test file names (so they don't accidentally clash with real files on the system)
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(5))


CONF_FILE = "/tmp/test_malware_detection_client_%s.conf" % get_random_string()
# Tests may be run in either the tests directory or its parent, so need to adjust test filenames accordingly
TEST_DIR = '.' if os.getcwd().endswith('tests') else 'tests'
DATA_DIR = '../data' if TEST_DIR == '.' else 'data'
TEST_CLIENT = "%s/test_malware_detection_client.py" % TEST_DIR
TEST_PARSE = "%s/test_parse_scan_output.py" % TEST_DIR
TEST_NETWORK = "%s/test_network_functions.py" % TEST_DIR
RULE1 = "%s/rule1.yar" % TEST_DIR
RULE2 = "%s/rule2.yar" % TEST_DIR
RULES_COMPILED = "%s/rules_compiled.yar" % TEST_DIR
RULE_RULE = "%s/rule rule.yar" % TEST_DIR
RULE_METADATA_TEST = "%s/rule_metadata_test.yar" % TEST_DIR
RULE_TEST_RHIMD = "%s/TEST_RedHatInsightsMalwareDetection.yar" % TEST_DIR
MATCHING_ENTITY_FILE = "%s/matching_entity" % TEST_DIR
ANOTHER_MATCHING_ENTITY_FILE = "%s/another matching_entity" % TEST_DIR
CRC_URL = 'https://cert.console.redhat.com'
CRC_RULE_URL = CRC_URL + '/signatures.yar'
RESULTS_URL = 'http://127.0.0.1/graphql'
KEYCLOAK_URL = 'http://127.0.0.1/token'
TEST_RULE_URL = 'http://127.0.0.1/test-rule.yar'
LOCATION_PARAMS = {'rules_location': RULES_COMPILED, 'results_url': RESULTS_URL}
VALID_INSIGHTS_ID = '11111111-1111-1111-1111-111111111111'
INVALID_INSIGHTS_ID = '66666666-6666-6666-6666-666666666666'
TEST_CERT_KEY_FILE = '%s/cert_key.pem' % TEST_DIR


def remove_conf_file(conf_file=CONF_FILE):
    if os.path.exists(conf_file):
        os.remove(conf_file)


def full(path):
    """
    Return the full filesystem path for the 'path' argument
    """
    return os.path.abspath(path)


def tld(path):
    """
    Return the top level directory for 'path' argument
    """
    full_path = os.path.abspath(path)
    if full_path == '/':
        return full_path

    parent_dirs = []
    get_parent_dirs(full_path, parent_dirs)
    return parent_dirs[0]
