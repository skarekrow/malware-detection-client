import os
import pytest
from malware_detection_client import MalwareDetectionClient, utils
from .constants import remove_conf_file, CONF_FILE, LOCATION_PARAMS


@pytest.fixture(autouse=True)
def prep_conf_file():
    """
    Fixture to create and remove a configuration file that will be used throughout all the tests
    It includes the necessary rule_location and results_url options
    """
    # Make sure the conf file doesn't exist before trying to create it
    remove_conf_file()
    with pytest.raises(SystemExit):
        MalwareDetectionClient(new_conf_file=CONF_FILE, **LOCATION_PARAMS)
    yield
    # Clean up after the test has finished
    remove_conf_file()


@pytest.fixture
def remove_jwt_token_cache():
    """
    Fixture to remove the user's jwt token cache if it exists
    It's existence may cause some tests to fail
    """
    jwt_token_cache = utils.get_jwt_token_cache()
    if os.path.exists(jwt_token_cache):
        os.remove(jwt_token_cache)
    yield
    if os.path.exists(jwt_token_cache):
        os.remove(jwt_token_cache)
