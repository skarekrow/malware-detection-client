from setuptools import setup, find_packages
import setuptools.command.bdist_rpm as orig

install_requires = [
    'requests',
    'iniparse',
    'six',
    'urllib3',
    'PyJWT',
]

extras_require = {
    "dev": [
        'flake8',
        'pytest',
        'responses',
        'tox'
    ]
}

data_files = [(
    '/etc/malware-detection-client', [
        'data/malware-detection-client.conf',
        'data/filesystem_include.txt',
        'data/filesystem_exclude.txt'
    ]
)]

permissions = [
    ('/etc/malware-detection-client', 'malware-detection-client.conf', '(600, root, root)'),
]

long_description = """Python wrapper script for the YARA malware detection tool.
Adds extra controls and features around how scans are performed.
Scan results are uploaded to Red Hat Insights for analysis.
"""


# Extend the bdist_rpm class to add extra attributes to the data files in the rpm spec
# Inspired by https://stackoverflow.com/questions/5932804/set-file-permissions-in-setup-py-file
class bdist_rpm(orig.bdist_rpm):
    def _make_spec_file(self):
        spec = orig.bdist_rpm._make_spec_file(self)
        for path, files in data_files:
            spec.extend(['%config {}/*'.format(path)])
        for path, files, perm in permissions:
            spec.extend(['%attr{} {}/{}'.format(perm, path, files)])
        return spec

setup(
    name="malware-detection-client",
    version="0.0.2",
    license='GPLv2+',
    description="Uploads YARA scan results to Red Hat Insights",
    long_description=long_description,
    url="https://github.com/RedHatInsights/malware-detection-client",
    packages=find_packages(where='src'),
    package_dir={'': 'src'},
    scripts=['src/malware-detection-client'],
    install_requires=install_requires,
    extras_require=extras_require,
    data_files=data_files,
    cmdclass={'bdist_rpm': bdist_rpm}
)
