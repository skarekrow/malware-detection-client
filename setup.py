from setuptools import setup, find_packages
import setuptools.command.bdist_rpm as orig

DESCRIPTION = "Uploads YARA scan results to Red Hat Insights"
LONG_DESCRIPTION = """Python wrapper script for the YARA malware detection tool.
Adds extra controls and features around how scans are performed.
Scan results are uploaded to Red Hat Insights for analysis.
"""

install_requires = [
    'requests',
    'iniparse',
    'urllib3',
]

extras_require = {
    "dev": [
        'PyJWT',
        'flake8',
        'pytest',
        'responses',
        'tox'
    ]
}

data_files = [
    ('/etc/malware-detection-client', [
        'data/malware-detection-client.conf',
        'data/filesystem_include.txt',
        'data/filesystem_exclude.txt'
    ]),
    ('/usr/lib/systemd/system', [
        'data/systemd/malware-detection-client.service',
        'data/systemd/malware-detection-client.timer',
    ])
]

permissions = [
    ('/etc/malware-detection-client', 'malware-detection-client.conf', '(600, root, root)'),
]


# Extend the bdist_rpm class to add extra attributes to the data files in the rpm spec
# Inspired by https://stackoverflow.com/questions/5932804/set-file-permissions-in-setup-py-file
class bdist_rpm(orig.bdist_rpm):
    def _make_spec_file(self):
        spec = orig.bdist_rpm._make_spec_file(self)
        for path, files in data_files:
            spec.extend(['%config {}/*'.format(path)])
        for path, files, perm in permissions:
            spec.extend(['%attr{} {}/{}'.format(perm, path, files)])
        return spec


def get_version():
    with open('src/malware_detection_client/__init__.py') as f:
        for line in f:
            if line.startswith('__version__'):
                delim = '"' if '"' in line else "'"
                return line.split(delim)[1]
        else:
            raise RuntimeError("Unable to find version string.")


setup(
    name="malware-detection-client",
    version=get_version(),
    description=DESCRIPTION,
    long_description=LONG_DESCRIPTION,
    url="https://github.com/RedHatInsights/malware-detection-client",
    license='GPLv2+',
    packages=find_packages(where='src'),
    package_dir={'': 'src'},
    scripts=['src/malware-detection-client'],
    install_requires=install_requires,
    extras_require=extras_require,
    data_files=data_files,
    cmdclass={'bdist_rpm': bdist_rpm}
)
