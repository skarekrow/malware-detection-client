#!/usr/libexec/platform-python
import argparse
from malware_detection_client import (
    MalwareDetectionClient,
    CONF_FILE,
    __version__ as version
)


def get_args():
    # Certain values may be supplied as command line arguments to MalwareDetectionClient
    p = argparse.ArgumentParser(description="Arguments will override corresponding values from the config files")
    p.add_argument('-r', '--rules', help='Location of the rules, ie HTTP URL or local file', default='',
                   metavar='RULES_LOCATION')
    p.add_argument('-u', '--upload', help='Upload results to the specified URL', default='',
                   metavar='UPLOAD_LOCATION')
    p.add_argument('-s', '--scan', help='Scan only this file, dir or pid.  Ignored if --test option used as well',
                   metavar='FILE|DIR|PID')
    p.add_argument('-S', '--save-rules', help='Save the downloaded rules to this file', metavar='SAVED_RULES_FILE')
    p.add_argument('-x', '--exclude-rules', help='Comma separated list of rules to exclude from the scan',
                   metavar='RULE1,RULE2,ETC')
    p.add_argument('-c', '--conf', help='Specify the configuration file location (default: %s)' % CONF_FILE,
                   default=CONF_FILE, metavar='CONF_FILE')
    p.add_argument('-C', '--create', help='Create a configuration file (overwrites existing NEW_CONF_FILE)',
                   metavar='NEW_CONF_FILE')
    p.add_argument('-n', '--no-upload', action='store_true', help="Skip uploading scan results at the end")
    p.add_argument('-t', '--test', action='store_true',
                   help='Perform a simple test scan of the system using a test rule.  Overrides --scan option if used together.')
    p.add_argument('-d', '--debug', action='store_true', help='Enable debug level logging')
    p.add_argument('-v', '--version', action='store_true', help='Display the version number')
    return p.parse_args()


def main():
    args = get_args()
    if args.version:
        print(version)
        exit(0)

    mdc = MalwareDetectionClient(rules_location=args.rules,
                                 results_url=args.upload,
                                 scan_entity=args.scan,
                                 saved_rules_file=args.save_rules,
                                 exclude_rules=args.exclude_rules,
                                 conf_file=args.conf,
                                 new_conf_file=args.create,
                                 no_upload=args.no_upload,
                                 test_option=args.test,
                                 debug=args.debug)
    mdc.run()


if __name__ == "__main__":
    main()
