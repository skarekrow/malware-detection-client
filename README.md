**malware-detection-client** is a Python wrapper script for the YARA malware detection tool.  It adds extra features such as downloading rules from and uploading results to Red Hat Insights for analysis.  It is intended to be run on RHEL systems and indeed has only been tested on RHEL7 & 8.

The YARA malware detection tool needs to be installed on the system first.  It can be downloaded and installed from [here](https://yara.readthedocs.io/en/stable/gettingstarted.html).  Prebuilt RPMs for RHEL7 & 8 may also be available.

YARA rules will be need to be available to, or on, the system.  Rules define the malware signatures the YARA tool is searching for.  The `[rules] location` option in the configuration file is used to specify their location, or you can use the `-r` option.  

Also, the `[results] location` option will need to be configured before running the client.  This specifies where to send the scan results.  Or you can use the `-n` option to skip uploading results.

Use the script's `-h` help option and read the configuration file to learn how the various configuration options work.


## Developing ##

To setup a development environment, run `make venv27` or `make venv36` to create virtualenvs for Python 2.7 or 3.6 (note that those python versions must already exist on the dev system).  For example to create a Python 2.7 dev environment run:

    $ make venv27
    $ . venv27/bin/activate

You can then run the development client script like so:

    (venv27) $ malware-detection-client

To scan a particular directory or PID using a particular rules file, run:

    (venv27) $ malware-detection-client -r <rules_file> -s <scan_dir|PID>

### NOTES... ###

* **sudo**

To scan most of the files/directories/PIDs on a system, the script will need to be run via **sudo**.  To run the **development** script via sudo, you can use the convenience script `sudoclient`, like so:

```
(venv) $ sudoclient [malware-detection-client_options]
```

This is because sudo's setting `secure_path = /sbin:/bin:/usr/sbin:/usr/bin` means sudo won't be able to find the script in the virtualenv.  If you run `sudo malware-detection-client` it will use the system `/usr/bin/malware-detection-client` script (if it exists) and not the development one.


* **Configuration file**

By default, the client script looks for a configuration file in `/etc/malware-detection-client/malware-detection-client.conf`.  By default it is readable only by root.  If you run the client as non-root it won't be able to use this file, but you can specify an alternate configuration file with the `-c` option, like so:

```
(venv) $ malware-detection-client -c data/malware-detection-client.conf
```

... which will use the configuration file from the repo.

## Testing ##

The tests must be run in an active virtualenv:

    (venv) $ make test

Tox is also provided to automatically run all the tests against Python 2.7 (RHEL7) & 3.6 (RHEL8):

    (venv) $ tox

## Creating RPMs ##

To create a RHEL7 or RHEL8 RPM, first you'll need to be on a RHEL7 or RHEL8 system.  Also make sure you're **not** in an active virtual environment.

    $ make rpm

The rpm will be created in the `dist` directory.  You can install it with:

    $ sudo yum localinstall dist/malware-detection-client-<version>.noarch.rpm
