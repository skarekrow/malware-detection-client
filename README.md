# Overview #

**malware-detection-client** is a Python wrapper script for the YARA malware detection tool.  It adds extra features such as downloading rules from and uploading results to Red Hat Insights for analysis.  It is intended to be run on RHEL systems and indeed has only been tested on RHEL7 & 8.

Pre-requisite steps for using the Malware Detection Client with Red Hat Insights:
1. Install the Yara malware detection tool
2. Register the system with Subscription Manager to either the Red Hat Customer Portal or Red Hat Satellite.  (Note, this step has likely been done already at system install time)
3. Register the system to Red Hat Insights

The malware detection client can be used independent of Red Hat Insights, but either way, the YARA malware detection tool needs to be installed on the system.  It can be downloaded and installed from [here](https://yara.readthedocs.io/en/stable/gettingstarted.html).  RPMs for yara for RHEL7 & 8 are also be available on [Fedora EPEL](https://docs.fedoraproject.org/en-US/epel/).

YARA rules will be need to be available to, or on, the system.  Rules define the malware signatures the YARA tool is searching for.  The `[client] rules_location` option in the configuration file is used to specify their location, or you can use the `-r` option on the command line.

Also, the `[client] results_location` configuration option will need to be set for specifying where to upload the scan results, or you can use the `-u` on the command line.  Alternatively the `-n` option can be used to skip uploading results.

The script takes a number of command line options.  Use the `-h` help option and read the configuration file in `/etc/malware-detection-client/malware-detection-client.conf` to learn how the various configuration options work.

    $ malware-detection-client -h
    $ sudo cat /etc/malware-detection-client/malware-detection-client.conf

### Common options ###
To use a particular rules file, use the `-r` option, eg:

    $ sudo malware-detection-client -r myrules.yar

To scan a just particular file/directory or PID use the `-s` option, eg:

    $ sudo malware-detection-client -s thing/to/scan

For more fine-grained control of what files/directories to scan and what not to scan, use the `/etc/malware-detection-client/filesystem_include.txt` and `/etc/malware-detection-client/filesystem_exclude.txt` files.

### Test option ###

To test that malware-detection-client is installed correctly and can download rules and upload results, use the `-t` to perform a test scan and upload.  The results from this scan are not recorded but demonstrate the client is installed and configured correctly.

    $ sudo malware-detection-client -t

---
# Developing #

To set up a development environment for the client, run `make venv2` or `make venv3` to create virtualenvs for Python 2 or 3 (these python versions must already exist on the dev system though).  For example to create a Python 3 dev environment run:

    $ sudo yum install make python3-virtualenv
    $ make venv3
    $ . venv3/bin/activate

Note: Setting up `venv2` will be similar, but you'll need to `sudo yum install make python-virtualenv` instead.
You can then run the development client script like so:

    (venv3) $ malware-detection-client

### NOTES... ###

* **sudo**

To scan most of the files/directories/PIDs on a system, the script will need to be run via **sudo**.  To run the **development** script via sudo, you can use the convenience script `sudoclient`, like so:

```
(venv3) $ sudoclient [malware-detection-client_options]
```

This is because sudo's setting `secure_path = /sbin:/bin:/usr/sbin:/usr/bin` means sudo won't be able to find the script in the virtualenv.  If you run `sudo malware-detection-client` it will use the system `/usr/bin/malware-detection-client` script (if it exists) and not the development one.


* **Configuration file**

By default, the client script looks for a configuration file in `/etc/malware-detection-client/malware-detection-client.conf`.  By default it is readable only by root.  If you run the client as non-root it won't be able to use this file, but you can specify an alternate configuration file with the `-c` option, like so:

```
(venv3) $ malware-detection-client -c data/malware-detection-client.conf
```

... which will use the configuration file from the repo.

---
# Testing #

The tests must be run in an active virtualenv:

    (venv3) $ make test

Tox is also provided to automatically run all the tests against Python 2.7 (RHEL7) & 3.6 (RHEL8):

    (venv3) $ tox

[Travis CI](https://app.travis-ci.com/github/RedHatInsights/malware-detection-client) has also been configured to run all the tests on code pushes to the repo.  It tests against python 2.7, 3.6 and 3.9 (for RHEL9).

---
# Creating RPMs #

To create an RPM make sure you're **not** in an active virtual environment.  You'll need to install the `rpm-build` and `python3-devel` packages (`python-devel` on RHEL7) first:

    $ sudo yum install rpm-build python3-devel
    $ make rpm

The rpm will be created in the `dist` directory.  You can install it with:

    $ make install-rpm

... or manually:

    $ sudo yum install dist/malware-detection-client-<version>.noarch.rpm
