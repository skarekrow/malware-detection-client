**malware-detection-client** is a Python wrapper script for the YARA malware detection tool.  It adds extra features such as downloading rules from and uploading results to Red Hat Insights for analysis.  It is intended to be run on RHEL systems and indeed has only been tested on RHEL7 & 8.

The YARA malware detection tool needs to be installed on the system first.  It can be downloaded and installed from [here](https://yara.readthedocs.io/en/stable/gettingstarted.html).  Prebuilt RPMs for RHEL7 & 8 may also be available.

YARA rules will be need to be available to, or on, the system.  Rules define the malware signatures the YARA tool is searching for.  The `[rules] location` option in the configuration file is used to specify their location, or you can use the `-r` option.  

Also, the `[results] location` option will need to be configured before running the client.  This specifies where to send the scan results.  Or you can use the `-n` option to skip uploading results.

Use the script's `-h` help option and read the configuration file to learn how the various configuration options work.


## Developing ##

To set up a development environment, run `make venv2` or `make venv3` to create virtualenvs for Python 2 or 3 (these python versions must already exist on the dev system though).  For example to create a Python 3 dev environment run:

    $ sudo yum install make python3-virtualenv
    $ make venv3
    $ . venv3/bin/activate

Note: Setting up `venv2` will be similar, but you'll need to `sudo yum install make python-virtualenv` instead.
You can then run the development client script like so:

    (venv3) $ malware-detection-client

To scan a particular directory or PID using a particular rules file, run:

    (venv3) $ malware-detection-client -r <rules_file> -s <scan_dir|PID>

### NOTES... ###

* **sudo**

To scan most of the files/directories/PIDs on a system, the script will need to be run via **sudo**.  To run the **development** script via sudo, you can use the convenience script `sudoclient`, like so:

```
(venv3) $ sudoclient [malware-detection-client_options]
```

This is because sudo's setting `secure_path = /sbin:/bin:/usr/sbin:/usr/bin` means sudo won't be able to find the script in the virtualenv.  If you run `sudo malware-detection-client` it will use the system `/usr/bin/malware-detection-client` script (if it exists) and not the development one.


* **Configuration file**

By default, the client script looks for a configuration file in `/etc/malware-detection-client/malware-detection-client.conf`.  By default it is readable only by root.  If you run the client as non-root it won't be able to use this file, but you can specify an alternate configuration file with the `-c` option, like so:

```
(venv3) $ malware-detection-client -c data/malware-detection-client.conf
```

... which will use the configuration file from the repo.

## Testing ##

The tests must be run in an active virtualenv:

    (venv3) $ make test

Tox is also provided to automatically run all the tests against Python 2.7 (RHEL7) & 3.6 (RHEL8):

    (venv3) $ tox

## Creating RPMs ##

To create an RPM make sure you're **not** in an active virtual environment.  You'll need to install the `rpm-build` and `python3-devel` packages (`python-devel` on RHEL7) first:

    $ sudo yum install rpm-build python3-devel
    $ make rpm

The rpm will be created in the `dist` directory.  You can install it with:

    $ make install-rpm

... or manually:

    $ sudo yum localinstall dist/malware-detection-client-<version>.noarch.rpm
